<!DOCTYPE html>
<html class="white">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" value="notranslate">
  <title>Blockly Demo:</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    .blocklyMainBackground {
      /* fill: #fff !important; */
      fill: #0B1725 !important;
    }

    .black .blocklyMainBackground {
      fill: #0B1725 !important;
    }

    .black .block-fill>path {
      fill-opacity: 0.1;
    }

    .black .geras-renderer.classic-theme .blocklyEditableText>rect {
      fill-opacity: 1;
      fill: #174273;
    }

    .black .geras-renderer.classic-theme .blocklyEditableText>text,
    .black .geras-renderer.classic-theme .blocklyEditableText>text>tspan {
      fill: #F9AA0F !important;
    }


    .white .blocklyMainBackground {
      fill: #fff !important;
    }

    .white .geras-renderer.classic-theme .blocklyEditableText>rect {
      fill-opacity: 1;
      fill: #169BD5;
    }

    .white .geras-renderer.classic-theme .blocklyEditableText>text,
    .white .geras-renderer.classic-theme .blocklyEditableText>text>tspan {
      fill: #FFFFFF !important;
    }

    .white .block-fill>path {
      fill-opacity: 0.1;
    }

    .white .geras-renderer.classic-theme .state .blocklyEditableText>rect {
      fill: #999999 !important;
    }

    .keyword {
      font-weight: bold !important;
    }

    .block-fill>path {
      /* fill: #272822 !important; */
      /* fill: rgba(0,0,0,.1) !important; */
      /* fill: rgba(255, 255, 255, 0.2) !important; */
      /* fill: transparent !important; */
      /* filter: url(#shadowGrey); */
    }

    .block-fill>.blocklyPathLight {
      fill: none !important;
    }

    /*  .controls_if > path{
      stroke: #F9273C !important;
    }
    .controls_if > g > text{
      fill: #F9273C !important;
    } */

    /* .geras-renderer.classic-theme .blocklyNonEditableText>rect, .geras-renderer.classic-theme .blocklyEditableText>rect {
      fill-opacity: 1;
      fill: #174273;
    } */
    /* .geras-renderer.classic-theme .blocklyNonEditableText>text, .geras-renderer.classic-theme .blocklyEditableText>text {
      fill: #F9AA0F !important;
    } */
  </style>
  <!-- <link rel="stylesheet/less" type="text/css" href="code.less"/> -->
</head>

<body>
  <table width="100%" height="100%">
    <tr>
      <td>
        <h1><a href="https://developers.google.com/blockly/">Blockly</a>&rlm; &gt;
          <a href="../index.html">Demos</a>&rlm; &gt;
          <span id="title">...</span>
        </h1>
      </td>
      <td class="farSide">
        <select id="languageMenu"></select>
      </td>
    </tr>
    <tr>
      <td colspan=2>
        <table width="100%">
          <tr id="tabRow" height="1em">
            <td id="tab_blocks" class="tabon">...</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_javascript" class="taboff tab_collapse">JavaScript</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_python" class="taboff tab_collapse">Python</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_php" class="taboff tab_collapse">PHP</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_lua" class="taboff tab_collapse">Lua</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_dart" class="taboff tab_collapse">Dart</td>
            <td class="tabmin tab_collapse">&nbsp;</td>
            <td id="tab_xml" class="taboff tab_collapse">XML</td>
            <td class="tabmin">
              <input type="file" name="loadXml" id="loadXml" />
            </td>
            <td>
              <input type="button" value="生成状态图json" id="genStateData" />
            </td>
            <td id="tab_code" class="taboff">
              <select id="code_menu"></select>
            </td>
            <td class="tabmax">
              <button id="trashButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="trash icon21">
              </button>
              <button id="linkButton" class="notext" title="...">
                <img src='../../media/1x1.gif' class="link icon21">
              </button>
              <button id="runButton" class="notext primary" title="...">
                <img src='../../media/1x1.gif' class="run icon21">
              </button>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td height="99%" colspan=2 id="content_area">
      </td>
    </tr>
  </table>
  <div id="content_blocks" class="content"></div>
  <pre id="content_javascript" class="content prettyprint lang-js"></pre>
  <pre id="content_python" class="content prettyprint lang-py"></pre>
  <pre id="content_php" class="content prettyprint lang-php"></pre>
  <pre id="content_lua" class="content prettyprint lang-lua"></pre>
  <pre id="content_dart" class="content prettyprint lang-dart"></pre>
  <textarea id="content_xml" class="content" wrap="off"></textarea>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="%{BKY_CATLOGIC}" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="%{BKY_CATLOOPS}" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="%{BKY_CATMATH}" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2">
        <value name="X">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="Y">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="%{BKY_CATTEXT}" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="%{BKY_CATLISTS}" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
    </category>
    <!-- <category name="%{BKY_CATCOLOUR}" colour="%{BKY_COLOUR_HUE}">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb">
        <value name="RED">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="GREEN">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="BLUE">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="colour_blend">
        <value name="COLOUR1">
          <shadow type="colour_picker">
            <field name="COLOUR">#ff0000</field>
          </shadow>
        </value>
        <value name="COLOUR2">
          <shadow type="colour_picker">
            <field name="COLOUR">#3333ff</field>
          </shadow>
        </value>
        <value name="RATIO">
          <shadow type="math_number">
            <field name="NUM">0.5</field>
          </shadow>
        </value>
      </block>
    </category> -->
    <sep></sep>
    <category name="%{BKY_CATVARIABLES}" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
    <category name="%{BKY_CATFUNCTIONS}" colour="%{BKY_PROCEDURES_HUE}" custom="PROCEDURE"></category>
    <category name="Class" colour="%{BKY_CLASS_HUE}">
      <block type="thread">
      <value name="CALLBACK">
        <shadow type="anonymous_function">
            <field name="callback">function</field>
          </shadow>
        </value>
      </block>
      <!-- <block type="anonymous_function"></block> -->
      <block type="state"></block>
      <block type="def_state"></block>
      <block type="run_state"></block>
      <block type="class"></block>
      <block type="class_property"></block>
      <block type="class_method"></block>
      <block type="get_class_property"></block>
      <block type="get_class_property3"></block>
      <block type="set_class_property"></block>
      <block type="set_class_property3"></block>
      <block type="set_class_property4"></block>
      <block type="set_class_property5"></block>
      <block type="set_class_property6"></block>
      <block type="class_method_return"></block>
      <block type="class_method_return4"></block>
      <block type="class_method_noreturn"></block>
      <block type="class_method_noreturn_with_params1"></block>
      <block type="method_return"></block>
      <block type="create_obj"></block>
      <block type="start"></block>
      <block type="new"></block>
      
      
      <!-- <block type="methods_defreturn"></block> -->
    </category>
  </xml>

  <!-- <script src="/storage.js"></script> -->
  <!-- <script src="../../blockly_compressed.js"></script> -->
  <!-- <script src="../../blocks_compressed.js"></script> -->

  <script src="../../blockly_uncompressed.js"></script>

  <script src="../../blocks/colour.js"></script>
  <script src="../../blocks/lists.js"></script>
  <script src="../../blocks/logic.js"></script>
  <script src="../../blocks/loops.js"></script>
  <script src="../../blocks/math.js"></script>
  <script src="../../blocks/procedures.js"></script>
  <script src="../../blocks/text.js"></script>
  <script src="../../blocks/variables.js"></script>

  <script src="../../javascript_compressed.js"></script>
  <script src="../../python_compressed.js"></script>
  <script src="../../php_compressed.js"></script>
  <script src="../../lua_compressed.js"></script>
  <script src="../../dart_compressed.js"></script>

  <script src="./code.js"></script>
  
  <script type="text/javascript" src="./defineBlock.js"></script>
  <script type="text/javascript" src="./generate.js"></script>
  <script>
    const isStateInOptions = (state, options) => {
      let flag = false;
      options.forEach(option => {
        if(option[0] == state.name){
          flag = true;
          return false; //注意：这里的return false是退出forEach循环
        }
      })
      return flag;
    }
    const beforeLoadBlocks = (xmlStr)=>{
      let threadAry = window.parent.statePageVue.threadAry;
      threadAry.forEach(thread => {
        thread.stateAry.forEach(state => {
          //如果状态的描述不在run_state的options中，则需要手动添加进去
          if(!isStateInOptions(state, window.run_state_options)){
            window.run_state_options.push([state.name, state.name]);
          }
        })
      })
      //重新定义run_state块 
    }
    window.addEventListener('message', function (e) {
      // Code.workspace.clear();
      beforeLoadBlocks(e.data);
      Code.loadBlocks(e.data);
      // Code.loadBlocks(localStorage.getItem('stateData'));
    })
    var importBtn = document.getElementById('loadXml');
    importBtn.addEventListener('change', function (e) {
      var file = e.target.files[0];
      var reader = new FileReader();
      reader.onload = (fe) => {
        // alert(localStorage.getItem('stateData'));
        beforeLoadBlocks(fe.target.result);
        Code.loadBlocks(fe.target.result);
      };
      reader.readAsText(file);
    })

    var genStateDataBtn = document.getElementById('genStateData');
    genStateDataBtn.addEventListener('click', function (e) {
      //TODO
      var xmlDom = Blockly.Xml.workspaceToDom(Code.workspace);
      debugger;
      if (xmlDom.children.length) {

      }
      const STATE_BLOCK = 'run_state';
      let stateAry = [];
      let lineAry = [];
      let tmpIndex = 0;
      function parseStateAndLine(stateDom) {

        // let randomXY = Math.floor(Math.random() * 10) * 50;
        let randomXY = (tmpIndex++) * 150;
        let item = stateDom;
        if (item.tagName === 'block' && item.getAttribute('type') === STATE_BLOCK) {
          let stateObj = {
            stateId: item.getAttribute('id'),
            stateType: item.getAttribute('type') === STATE_BLOCK ? 'stateDiv': 'loopDiv',
            bx: parseInt(item.x, 10), // blockly画布中的x
            by: parseInt(item.y, 10), // blockly画布中的y
            x: randomXY, //'? todo',
            y: randomXY, //'? todo',
            width: '76px',
            height: '40px',
            name: item.firstChild.textContent,
            inputAry: [],
            outputAry: [],
            children: [],
            nodeHeight: 0 // 如果该节点有2个分支，且分支是叶子节点，则这个节点的nodeHeight = 2; 总之，nodeHeight = 各分支nodeHeight之和 - 这个参数为自动布局所用
          }

          let children = Array.prototype.slice.call(item.children);
          children.forEach(dom => {
            if (dom.tagName === 'next' && dom.children.length) { // dom-next
              let block = dom.children[0];  // block-controls_if
              for (let k = 0; k < block.children.length; k++) {
                let branch = block.children[k];
                if (branch.tagName === 'statement') { // 还有可能是mutation
                  let lineObj = {
                    lineId: branch.getAttribute('id') || window.parent.genId('line'), // TODO 需改写controls_if的statement逻辑，并定义id
                    d: null,
                    desc: '',
                    startPoint: null,
                    endPoint: null,
                    startState: {
                      stateId: stateObj.stateId,
                      stateIndex: null
                    },
                    endState: {
                      stateId: branch.firstChild.getAttribute('id'),
                      stateIndex: null
                    }
                  }
                  lineAry.push(lineObj);
                  parseStateAndLine(branch.firstChild);
                }
              }
            }
          })
          stateAry.push(stateObj);
        }

      }
      for (let j = 0; j < xmlDom.children.length; j++) {
        let item = xmlDom.children[j];
        parseStateAndLine(item);
      }
      let updateLineAry = (lineAry, stateAry)=>{
        let createPathByStates = (startState, endState)=>{
          const MID_POINT_X = 50;
          let toNum = (strWithPx)=>{
            return parseInt(strWithPx.replace('px', ''), 10);
          }
          let startPoint = {
            x: startState.x + toNum(startState.width),
            y: startState.y + 1/2 * toNum(startState.height) + 40 // 80是thread-body元素的纵向偏移
          };
          let endPoint = {
            x: endState.x,
            y: endState.y + 1 / 2 * toNum(endState.height) + 40
          }
          return `M ${startPoint.x} ${
            startPoint.y
            } h ${MID_POINT_X} m 0 0 V ${endPoint.y} m 0 0 L ${endPoint.x} ${
            endPoint.y
            } m 0 0 z`     
        }

        lineAry.forEach(item => {
          if(!item.d){
            debugger;
            let startState = stateAry.find(state => {
              return state.stateId === item.startState.stateId;
            })
            let endState = stateAry.find(state => {
              return state.stateId === item.endState.stateId;
            })
            item.d = createPathByStates(startState, endState);
          }
        })
      }

      updateLineAry(lineAry, stateAry);

      window.aa = {
        stateAry: stateAry,
        lineAry: lineAry
      }
      debugger;
    });

    window.addEventListener('load', function () {

      var svg = document.querySelector('svg.blocklySvg');
      var defs = Blockly.utils.dom.createSvgElement('defs', {}, svg);
      var shadowGrey = Blockly.utils.dom.createSvgElement('filter', {
        id: 'shadowGrey',
        x: "0",
        y: "0",
        width: "100%",
        height: "100%"
      }, defs);
      Blockly.utils.dom.createSvgElement('feOffset', {
        in: 'SourceGraphic',
        result: 'offOut',
        dx: 0,
        dy: 0
      }, shadowGrey);
      Blockly.utils.dom.createSvgElement('feGaussianBlur', {
        in: 'offOut',
        stdDeviation: 1,
        result: 'blurOut',
      }, shadowGrey);
      Blockly.utils.dom.createSvgElement('feBlend', {
        in: 'SourceGraphic',
        in2: "blurOut",
        mode: "normal"
      }, shadowGrey);
    })


   
  </script>

</body>
<!-- <script>
  window.less = {
    env: "development",
    async: false,
    fileAsync: false,
    poll: 1000,
    functions: {},
    dumpLineNumbers: "comments",
    relativeUrls: false,
    rootpath: "./"
  };
</script>
<script src="less.js" type="text/javascript"></script> -->

</html>